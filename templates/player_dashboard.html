{% extends 'base.html' %}
{% block title %}Panel Gracza - {{ player_name }}{% endblock %}

{% block styles %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .dashboard-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
    }

    .dashboard-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .dashboard-header {
        text-align: center;
        margin-bottom: 25px;
    }

    .player-name {
        font-size: 1.8rem;
        font-weight: bold;
        color: #667eea;
        margin: 0;
    }

    .game-name {
        font-size: 1.1rem;
        color: #666;
        margin-top: 5px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .info-label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }

    .info-value.highlight {
        color: #667eea;
    }

    .timer-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 20px;
    }

    .timer-value {
        font-size: 2.5rem;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }

    .multiplier-badges {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .multiplier-badge {
        flex: 1;
        background: #e3f2fd;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
    }

    .multiplier-badge.time {
        background: #fff3e0;
    }

    .multiplier-badge.points {
        background: #e8f5e9;
    }

    .badge-label {
        font-size: 0.75rem;
        color: #666;
        margin-bottom: 3px;
    }

    .badge-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #333;
    }

    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }

    .action-btn {
        padding: 15px 10px;
        border: none;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .action-btn.password {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .action-btn.scan {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .action-btn.selfie {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .message-box {
        background: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
    }

    .message-box.visible {
        display: block;
    }

    .message-text {
        margin: 0;
        color: #333;
    }

    .language-selector {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding: 15px;
    }

    .lang-btn {
        width: 50px;
        height: 35px;
        border: 2px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
    }

    .lang-btn:hover {
        border-color: #667eea;
        transform: scale(1.1);
    }

    .lang-btn.active {
        border-color: #667eea;
        border-width: 3px;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 15px;
        padding: 25px;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2rem;
        cursor: pointer;
        color: #999;
        border: none;
        background: none;
    }

    .password-display {
        font-size: 2rem;
        font-family: 'Courier New', monospace;
        text-align: center;
        letter-spacing: 5px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-top: 15px;
    }

    #qr-reader {
        width: 100%;
        max-width: 500px;
    }

    .selfie-gallery {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .selfie-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }

    .selfie-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .selfie-info {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        text-align: center;
    }

    .vote-btn {
        background: #f093fb;
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 5px;
    }

    .vote-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-card">
        <div class="dashboard-header">
            <h1 class="player-name" id="player-name">{{ player_name }}</h1>
            <p class="game-name" id="game-name">≈Åadowanie...</p>
        </div>

        <!-- Timer -->
        <div class="timer-display">
            <div class="info-label" data-lang="time_remaining">Czas do ko≈Ñca</div>
            <div class="timer-value" id="timer-display">--:--</div>
        </div>

        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label" data-lang="active_players">Aktywni gracze</div>
                <div class="info-value" id="active-players">-</div>
            </div>
            <div class="info-item">
                <div class="info-label" data-lang="your_points">Twoje punkty</div>
                <div class="info-value highlight" id="player-points">0</div>
            </div>
            <div class="info-item">
                <div class="info-label" data-lang="points_earned">Zdobyte punkty</div>
                <div class="info-value" id="total-earned">0</div>
            </div>
            <div class="info-item">
                <div class="info-label" data-lang="points_available">Mo≈ºliwe punkty</div>
                <div class="info-value" id="points-available">-</div>
            </div>
        </div>

        <!-- Multipliers -->
        <div class="multiplier-badges">
            <div class="multiplier-badge time">
                <div class="badge-label" data-lang="time_speed">Tempo czasu</div>
                <div class="badge-value" id="time-speed">x1</div>
            </div>
            <div class="multiplier-badge points">
                <div class="badge-label" data-lang="point_bonus">Premia punktowa</div>
                <div class="badge-value" id="point-bonus">x1</div>
            </div>
        </div>

        <!-- Host Message -->
        <div class="message-box" id="message-box">
            <p class="message-text" id="message-text"></p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn password" id="btn-password">
                <span style="font-size: 1.5rem;">üîë</span>
                <span data-lang="btn_password">Has≈Ço</span>
            </button>
            <button class="action-btn scan" id="btn-scan">
                <span style="font-size: 1.5rem;">üì±</span>
                <span data-lang="btn_scan">Skanuj</span>
            </button>
            <button class="action-btn selfie" id="btn-selfie">
                <span style="font-size: 1.5rem;">ü§≥</span>
                <span data-lang="btn_selfie">Selfie</span>
            </button>
        </div>

        <!-- Language Selector -->
        <div class="language-selector">
            <button class="lang-btn active" data-lang="pl" title="Polski">üáµüá±</button>
            <button class="lang-btn" data-lang="en" title="English">üá¨üáß</button>
            <button class="lang-btn" data-lang="de" title="Deutsch">üá©üá™</button>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div class="modal-overlay" id="password-modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('password-modal')">&times;</button>
        <h3 data-lang="password_title">Has≈Ço do odkrycia</h3>
        <div class="password-display" id="password-display">_ _ _ _ _ _ _ _</div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal-overlay" id="scanner-modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('scanner-modal')">&times;</button>
        <h3 data-lang="scan_title">Skanuj kod QR</h3>
        <div id="qr-reader"></div>
        <p style="text-align: center; margin-top: 15px; color: #666;">
            <span data-lang="scan_instruction">Skieruj kamerƒô na kod QR</span>
        </p>
    </div>
</div>

<!-- Selfie Gallery Modal -->
<div class="modal-overlay" id="selfie-modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('selfie-modal')">&times;</button>
        <h3 data-lang="selfie_title">Galeria zabawnych selfie</h3>
        <div class="selfie-gallery" id="selfie-gallery">
            <!-- Selfies will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.socket.io/4.5.2/socket.io.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
// Translations
const translations = {
    pl: {
        time_remaining: 'Czas do ko≈Ñca',
        active_players: 'Aktywni gracze',
        your_points: 'Twoje punkty',
        points_earned: 'Zdobyte punkty',
        points_available: 'Mo≈ºliwe punkty',
        time_speed: 'Tempo czasu',
        point_bonus: 'Premia punktowa',
        btn_password: 'Has≈Ço',
        btn_scan: 'Skanuj',
        btn_selfie: 'Selfie',
        password_title: 'Has≈Ço do odkrycia',
        scan_title: 'Skanuj kod QR',
        scan_instruction: 'Skieruj kamerƒô na kod QR',
        selfie_title: 'Galeria zabawnych selfie',
        vote: 'Zag≈Çosuj',
        voted: 'Zag≈Çosowano'
    },
    en: {
        time_remaining: 'Time Remaining',
        active_players: 'Active Players',
        your_points: 'Your Points',
        points_earned: 'Points Earned',
        points_available: 'Available Points',
        time_speed: 'Time Speed',
        point_bonus: 'Point Bonus',
        btn_password: 'Password',
        btn_scan: 'Scan',
        btn_selfie: 'Selfies',
        password_title: 'Password to Discover',
        scan_title: 'Scan QR Code',
        scan_instruction: 'Point camera at QR code',
        selfie_title: 'Funny Selfie Gallery',
        vote: 'Vote',
        voted: 'Voted'
    },
    de: {
        time_remaining: 'Verbleibende Zeit',
        active_players: 'Aktive Spieler',
        your_points: 'Deine Punkte',
        points_earned: 'Verdiente Punkte',
        points_available: 'Verf√ºgbare Punkte',
        time_speed: 'Zeitgeschwindigkeit',
        point_bonus: 'Punktebonus',
        btn_password: 'Passwort',
        btn_scan: 'Scannen',
        btn_selfie: 'Selfies',
        password_title: 'Passwort zu entdecken',
        scan_title: 'QR-Code scannen',
        scan_instruction: 'Richten Sie die Kamera auf den QR-Code',
        selfie_title: 'Lustige Selfie-Galerie',
        vote: 'Abstimmen',
        voted: 'Abgestimmt'
    }
};

document.addEventListener('DOMContentLoaded', function() {
    const eventId = {{ event_id }};
    const playerId = {{ player_id }};
    let currentLang = localStorage.getItem('dashboard_lang') || 'pl';
    let html5QrCode = null;
    let votedPhotos = JSON.parse(localStorage.getItem(`voted_photos_${eventId}`) || '[]');

    const socket = io();

    // Initialize
    socket.on('connect', () => {
        console.log('Connected to server');
        socket.emit('join', { event_id: eventId });
        loadGameData();
    });

    // Language switching
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentLang = btn.dataset.lang;
            localStorage.setItem('dashboard_lang', currentLang);
            updateLanguage();

            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });

        if (btn.dataset.lang === currentLang) {
            btn.classList.add('active');
        }
    });

    function updateLanguage() {
        const trans = translations[currentLang];
        document.querySelectorAll('[data-lang]').forEach(el => {
            const key = el.dataset.lang;
            if (trans[key]) {
                if (el.tagName === 'BUTTON' && el.querySelector('span[data-lang]')) {
                    el.querySelector('span[data-lang]').textContent = trans[key];
                } else {
                    el.textContent = trans[key];
                }
            }
        });
    }

    // Load game data
    async function loadGameData() {
        try {
            const response = await fetch(`/api/player_dashboard/state?event_id=${eventId}&player_id=${playerId}`);
            const data = await response.json();

            if (data.error) {
                console.error('Error loading game data:', data.error);
                return;
            }

            updateDashboard(data);
        } catch (error) {
            console.error('Failed to load game data:', error);
        }
    }

    function updateDashboard(data) {
        // Game name
        document.getElementById('game-name').textContent = data.game_name || 'Saper Event';

        // Players
        document.getElementById('active-players').textContent = data.active_players || 0;

        // Points
        document.getElementById('player-points').textContent = data.player_score || 0;
        document.getElementById('total-earned').textContent = data.total_points_earned || 0;
        document.getElementById('points-available').textContent = data.points_available || 0;

        // Multipliers
        document.getElementById('time-speed').textContent = 'x' + (data.time_speed || 1);
        document.getElementById('point-bonus').textContent = 'x' + (data.point_bonus || 1);

        // Timer
        if (data.time_remaining !== undefined) {
            updateTimer(data.time_remaining);
        }

        // Password
        if (data.password_display) {
            document.getElementById('password-display').textContent = data.password_display;
        }

        // Host message
        if (data.host_message && data.host_message.trim()) {
            showMessage(data.host_message);
        } else {
            // Hide message if empty
            const messageBox = document.getElementById('message-box');
            messageBox.classList.remove('visible');
        }
    }

    function updateTimer(seconds) {
        if (seconds < 0) seconds = 0;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('timer-display').textContent =
            String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
    }

    function showMessage(text) {
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        messageText.textContent = text;
        messageBox.classList.add('visible');
    }

    // WebSocket events
    socket.on('game_state_update', (data) => {
        updateDashboard(data);
    });

    socket.on('host_message', (data) => {
        if (data.message) {
            showMessage(data.message);
        }
    });

    socket.on('password_update', (data) => {
        if (data.password_display) {
            document.getElementById('password-display').textContent = data.password_display;
        }
    });

    socket.on('timer_tick', (data) => {
        if (data.time_left !== undefined) {
            updateTimer(data.time_left);
        }
    });

    socket.on('leaderboard_update', (data) => {
        // Update player score if in leaderboard
        const player = data.find(p => p.id === playerId);
        if (player) {
            document.getElementById('player-points').textContent = player.score;
        }
    });

    socket.on('game_over', () => {
        showMessage('‚è∞ Gra zako≈Ñczona!');
    });

    // Button handlers
    document.getElementById('btn-password').addEventListener('click', () => {
        openModal('password-modal');
    });

    document.getElementById('btn-scan').addEventListener('click', () => {
        openModal('scanner-modal');
        startQRScanner();
    });

    document.getElementById('btn-selfie').addEventListener('click', async () => {
        openModal('selfie-modal');
        await loadSelfies();
    });

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    window.closeModal = function(modalId) {
        document.getElementById(modalId).classList.remove('active');
        if (modalId === 'scanner-modal' && html5QrCode) {
            html5QrCode.stop();
        }
    }

    // QR Scanner
    function startQRScanner() {
        const qrReaderEl = document.getElementById('qr-reader');
        qrReaderEl.innerHTML = '';

        html5QrCode = new Html5Qrcode("qr-reader");

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
                console.log('QR Code scanned:', decodedText);
                html5QrCode.stop();
                closeModal('scanner-modal');
                handleQRScan(decodedText);
            },
            (errorMessage) => {
                // Ignore scan errors
            }
        ).catch(err => {
            console.error('Unable to start scanner:', err);
            alert('Nie mo≈ºna uruchomiƒá skanera. Sprawd≈∫ uprawnienia do kamery.');
        });
    }

    async function handleQRScan(qrCode) {
        try {
            // Redirect to player page with scanned QR code
            window.location.href = `/player/${eventId}/${qrCode}`;
        } catch (error) {
            console.error('Error handling QR scan:', error);
        }
    }

    // Selfie gallery
    async function loadSelfies() {
        try {
            const response = await fetch(`/api/player/selfies?event_id=${eventId}`);
            const data = await response.json();

            const gallery = document.getElementById('selfie-gallery');
            gallery.innerHTML = '';

            if (!data.selfies || data.selfies.length === 0) {
                gallery.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Brak zdjƒôƒá</p>';
                return;
            }

            data.selfies.forEach(selfie => {
                const hasVoted = votedPhotos.includes(selfie.id);
                const item = document.createElement('div');
                item.className = 'selfie-item';
                item.innerHTML = `
                    <img src="${selfie.image_url}" alt="${selfie.player_name}">
                    <div class="selfie-info">
                        <div>${selfie.player_name}</div>
                        <div>‚ù§Ô∏è ${selfie.votes}</div>
                        <button class="vote-btn" data-id="${selfie.id}" ${hasVoted ? 'disabled' : ''}>
                            ${hasVoted ? translations[currentLang].voted : translations[currentLang].vote}
                        </button>
                    </div>
                `;
                gallery.appendChild(item);
            });

            // Add vote handlers
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', () => voteSelfie(btn.dataset.id));
            });
        } catch (error) {
            console.error('Error loading selfies:', error);
        }
    }

    async function voteSelfie(photoId) {
        try {
            const response = await fetch('/api/player/selfie/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    photo_id: parseInt(photoId),
                    player_id: playerId,
                    event_id: eventId
                })
            });

            const data = await response.json();

            if (data.success) {
                votedPhotos.push(parseInt(photoId));
                localStorage.setItem(`voted_photos_${eventId}`, JSON.stringify(votedPhotos));
                await loadSelfies(); // Reload gallery
            } else {
                alert(data.message || 'B≈ÇƒÖd g≈Çosowania');
            }
        } catch (error) {
            console.error('Error voting:', error);
        }
    }

    // Initialize language
    updateLanguage();

    // Refresh data periodically
    setInterval(loadGameData, 5000);
});
</script>
{% endblock %}
