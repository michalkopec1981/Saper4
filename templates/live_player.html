{% extends 'base.html' %}
{% block title %}Tryb Na ≈ªywo{% endblock %}
{% block content %}
<div class="container mt-4" style="max-width: 500px;">
    <div class="text-center">
        <h2>üéØ Tryb Na ≈ªywo</h2>
        <p class="text-muted">Czekaj na pytania od konferansjera</p>
        <hr>
    </div>

    <!-- Status oczekiwania -->
    <div id="waiting-section" class="text-center">
        <div class="card bg-light">
            <div class="card-body">
                <h5 class="mb-3">‚è≥ Oczekiwanie na pytanie...</h5>
                <p class="text-muted">Konferansjer uruchomi pytanie ze sceny</p>
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">≈Åadowanie...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Aktywne pytanie -->
    <div id="question-section" style="display: none;">
        <div class="card border-primary mb-3">
            <div class="card-body">
                <!-- Timer -->
                <div class="text-center mb-3">
                    <h4 class="text-danger">
                        ‚è±Ô∏è Czas: <span id="timer-display">30</span>s
                    </h4>
                </div>

                <!-- Pytanie (je≈õli dostƒôpne) -->
                <div id="question-text-container" style="display: none;">
                    <h5 class="mb-3" id="question-text"></h5>
                </div>

                <!-- Opcje odpowiedzi (je≈õli dostƒôpne) -->
                <div id="options-container" style="display: none;" class="mb-3">
                    <div id="option-a-container" style="display: none;">
                        <strong>A:</strong> <span id="option-a"></span>
                    </div>
                    <div id="option-b-container" style="display: none;">
                        <strong>B:</strong> <span id="option-b"></span>
                    </div>
                    <div id="option-c-container" style="display: none;">
                        <strong>C:</strong> <span id="option-c"></span>
                    </div>
                    <div id="option-d-container" style="display: none;">
                        <strong>D:</strong> <span id="option-d"></span>
                    </div>
                </div>

                <!-- Przyciski odpowiedzi -->
                <div id="answer-buttons" class="d-grid gap-3">
                    <button class="btn btn-lg btn-primary" onclick="submitAnswer('A')" id="btn-a">A</button>
                    <button class="btn btn-lg btn-primary" onclick="submitAnswer('B')" id="btn-b">B</button>
                    <button class="btn btn-lg btn-primary" onclick="submitAnswer('C')" id="btn-c" style="display: none;">C</button>
                    <button class="btn btn-lg btn-primary" onclick="submitAnswer('D')" id="btn-d" style="display: none;">D</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sekcja po udzieleniu odpowiedzi -->
    <div id="answered-section" style="display: none;">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h5>‚úÖ Odpowied≈∫ wys≈Çana!</h5>
                <p class="mb-0">Twoja odpowied≈∫: <strong id="your-answer"></strong></p>
                <p class="text-white-50 small mt-2">Czekaj na ujawnienie poprawnej odpowiedzi...</p>
            </div>
        </div>
    </div>

    <!-- Wynik po ujawnieniu -->
    <div id="result-section" style="display: none;">
        <div class="card" id="result-card">
            <div class="card-body text-center">
                <h4 id="result-title"></h4>
                <p id="result-message"></p>
                <button class="btn btn-primary" onclick="location.reload()">Gotowy na kolejne pytanie</button>
            </div>
        </div>
    </div>

    <!-- Komunikaty b≈Çƒôd√≥w -->
    <div id="error-section" style="display: none;">
        <div class="alert alert-danger" role="alert">
            <strong>B≈ÇƒÖd!</strong> <span id="error-message"></span>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const eventId = {{ event_id }};
    const qrCode = '{{ qr_code }}';
    let currentQuestionId = null;
    let timerInterval = null;
    let socket = null;

    // Po≈ÇƒÖcz z WebSocket
    socket = io();

    socket.on('connect', function() {
        console.log('Connected to WebSocket');
        socket.emit('join', {room: `event_${eventId}`});
    });

    // Nas≈Çuchuj na nowe pytania
    socket.on('live_question_started', function(data) {
        console.log('New question started:', data);
        checkQuestionStatus();
    });

    // Nas≈Çuchuj na ujawnienie odpowiedzi
    socket.on('live_answer_revealed', function(data) {
        console.log('Answer revealed:', data);
        checkQuestionStatus();
    });

    // Sprawd≈∫ status pytania
    async function checkQuestionStatus() {
        try {
            const response = await fetch(`/api/player/live/status/${eventId}/${qrCode}`);
            const data = await response.json();

            if (data.active) {
                currentQuestionId = data.question_id;
                showQuestion(data);
            } else {
                showWaiting();
            }
        } catch (error) {
            console.error('Error checking question status:', error);
            showError('Nie uda≈Ço siƒô pobraƒá statusu pytania');
        }
    }

    // Poka≈º sekcjƒô oczekiwania
    function showWaiting() {
        document.getElementById('waiting-section').style.display = 'block';
        document.getElementById('question-section').style.display = 'none';
        document.getElementById('answered-section').style.display = 'none';
        document.getElementById('result-section').style.display = 'none';
    }

    // Poka≈º pytanie
    function showQuestion(data) {
        // Ukryj sekcjƒô oczekiwania
        document.getElementById('waiting-section').style.display = 'none';

        // Sprawd≈∫ czy gracz ju≈º odpowiedzia≈Ç
        if (data.has_answered) {
            if (data.is_revealed) {
                showResult(data);
            } else {
                showAnswered();
            }
            return;
        }

        // Sprawd≈∫ czy odpowied≈∫ zosta≈Ça ujawniona
        if (data.is_revealed) {
            showResult(data);
            return;
        }

        // Poka≈º sekcjƒô pytania
        document.getElementById('question-section').style.display = 'block';
        document.getElementById('answered-section').style.display = 'none';
        document.getElementById('result-section').style.display = 'none';

        // Wy≈õwietl tre≈õƒá pytania je≈õli dostƒôpna
        if (data.question_text && data.question_text.trim() !== '') {
            document.getElementById('question-text-container').style.display = 'block';
            document.getElementById('question-text').textContent = data.question_text;
        } else {
            document.getElementById('question-text-container').style.display = 'none';
        }

        // Wy≈õwietl opcje odpowiedzi je≈õli dostƒôpne
        let hasOptions = false;
        if (data.option_a && data.option_a.trim() !== '') {
            document.getElementById('option-a-container').style.display = 'block';
            document.getElementById('option-a').textContent = data.option_a;
            hasOptions = true;
        }
        if (data.option_b && data.option_b.trim() !== '') {
            document.getElementById('option-b-container').style.display = 'block';
            document.getElementById('option-b').textContent = data.option_b;
            hasOptions = true;
        }
        if (data.option_c && data.option_c.trim() !== '') {
            document.getElementById('option-c-container').style.display = 'block';
            document.getElementById('option-c').textContent = data.option_c;
            hasOptions = true;
        }
        if (data.option_d && data.option_d.trim() !== '') {
            document.getElementById('option-d-container').style.display = 'block';
            document.getElementById('option-d').textContent = data.option_d;
            hasOptions = true;
        }

        if (hasOptions) {
            document.getElementById('options-container').style.display = 'block';
        }

        // Poka≈º odpowiednie przyciski na podstawie button_count
        const buttonCount = data.button_count || 3;
        document.getElementById('btn-a').style.display = 'block';
        document.getElementById('btn-b').style.display = 'block';
        document.getElementById('btn-c').style.display = buttonCount >= 3 ? 'block' : 'none';
        document.getElementById('btn-d').style.display = buttonCount >= 4 ? 'block' : 'none';

        // Uruchom timer
        if (data.time_remaining) {
            startTimer(Math.floor(data.time_remaining));
        }
    }

    // Poka≈º sekcjƒô po udzieleniu odpowiedzi
    function showAnswered() {
        document.getElementById('question-section').style.display = 'none';
        document.getElementById('answered-section').style.display = 'block';
        document.getElementById('result-section').style.display = 'none';

        if (timerInterval) {
            clearInterval(timerInterval);
        }
    }

    // Poka≈º wynik
    function showResult(data) {
        document.getElementById('question-section').style.display = 'none';
        document.getElementById('answered-section').style.display = 'none';
        document.getElementById('result-section').style.display = 'block';

        const resultCard = document.getElementById('result-card');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');

        // Tutaj mo≈ºemy dodaƒá logikƒô sprawdzania czy odpowied≈∫ by≈Ça poprawna
        // (wymaga dodatkowego endpointu API lub przekazania danych w data)

        resultCard.className = 'card border-info';
        resultTitle.textContent = '‚úÖ Pytanie zako≈Ñczone';
        resultMessage.innerHTML = `Poprawna odpowied≈∫: <strong>${data.correct_answer}</strong>`;

        if (timerInterval) {
            clearInterval(timerInterval);
        }
    }

    // Poka≈º b≈ÇƒÖd
    function showError(message) {
        document.getElementById('error-section').style.display = 'block';
        document.getElementById('error-message').textContent = message;
    }

    // Uruchom timer
    function startTimer(seconds) {
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        let timeRemaining = seconds;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.textContent = timeRemaining;

        timerInterval = setInterval(() => {
            timeRemaining--;
            timerDisplay.textContent = timeRemaining;

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }, 1000);
    }

    // Wy≈õlij odpowied≈∫
    async function submitAnswer(answer) {
        if (!currentQuestionId) {
            showError('Brak aktywnego pytania');
            return;
        }

        // Wy≈ÇƒÖcz przyciski
        const buttons = document.querySelectorAll('#answer-buttons button');
        buttons.forEach(btn => btn.disabled = true);

        try {
            const response = await fetch('/api/player/live/answer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    question_id: currentQuestionId,
                    answer: answer,
                    event_id: eventId,
                    qr_code: qrCode
                })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('your-answer').textContent = answer;
                showAnswered();
            } else {
                showError(data.error || 'B≈ÇƒÖd wysy≈Çania odpowiedzi');
                // W≈ÇƒÖcz przyciski z powrotem
                buttons.forEach(btn => btn.disabled = false);
            }
        } catch (error) {
            console.error('Error submitting answer:', error);
            showError('Nie uda≈Ço siƒô wys≈Çaƒá odpowiedzi');
            buttons.forEach(btn => btn.disabled = false);
        }
    }

    // Inicjalizacja - sprawd≈∫ status przy za≈Çadowaniu strony
    checkQuestionStatus();

    // Sprawdzaj status co 5 sekund (backup gdyby WebSocket nie dzia≈Ça≈Ç)
    setInterval(checkQuestionStatus, 5000);
</script>
{% endblock %}
